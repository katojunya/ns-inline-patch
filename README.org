#+title: An enhanced inline patch for GNU Emacs

[[https://github.com/takaxp/ns-inline-patch/actions?query=workflow%3A%22Build+NS+with+inline-patch+%28HEAD%29%22][https://github.com/takaxp/ns-inline-patch/workflows/Build%20NS%20with%20inline-patch%20(HEAD)/badge.svg]]
[[https://github.com/takaxp/ns-inline-patch/actions?query=workflow%3A%22Build+NS+with+inline-patch+%28emacs-28%29%22][https://github.com/takaxp/ns-inline-patch/workflows/Build%20NS%20with%20inline-patch%20(emacs-28)/badge.svg]]
[[https://github.com/takaxp/ns-inline-patch/actions?query=workflow%3A%22Build+NS+with+inline-patch+%28emacs-27%29%22][https://github.com/takaxp/ns-inline-patch/workflows/Build%20NS%20with%20inline-patch%20(emacs-27)/badge.svg]]
[[https://github.com/takaxp/ns-inline-patch/actions?query=workflow%3A%22Build+NS+with+inline-patch+%28emacs-26%29%22][https://github.com/takaxp/ns-inline-patch/workflows/Build%20NS%20with%20inline-patch%20(emacs-26)/badge.svg]]

see https://qiita.com/takaxp/items/e07bb286d80fa9dd8e05 and https://qiita.com/takaxp/items/6a7f9b26eb1b1a8237a0

Note: Version 28.1 has been released. The inline patch (emacs-28.1-inline.patch) is newly generated for Emacs 28.1. Installer packages for Intel-based Mac and Apple Silicon M1 Mac are also available.

** Supported features

 - avoid "M-x „ÅÇ"
 - faces for composing text
 - non ja locale
 - directly change input source

** Supported Emacs version

 - Emacs HEAD (emacs-head-inline.patch)
 - Emacs 28.1 (emacs-28.1-inline.patch)
 - Emacs 27.2, 27.1 (emacs-27.1-inline.patch)
 - Emacs 26.3, 26.2, 26.1 (emacs-25.2-inline.patch)
 - Emacs 25.3, 25.2 (emacs-25.2-inline.patch)

** Integrated functions

 - M-x mac-build-info

Note: This function is not valid in pre-built packages described in later section.

** How to use?

Add the following code to your init.el.

#+begin_src emacs-lisp
(when (and (memq window-system '(ns nil))
           (fboundp 'mac-get-current-input-source))
  (when (version< "27.0" emacs-version)
    ;; Required for some cases when auto detection is failed or the locale is "en".
    (custom-set-variables
     '(mac-default-input-source "com.google.inputmethod.Japanese.base")))
  (mac-input-method-mode 1))
#+end_src

** Build scripts

For your convenience, some build scripts are provided. Before you run the script, please run =setup.sh= first.

#+begin_src sh
sh ./build/setup.sh
sh ./build/emacs-28.1.sh
#+end_src

If your environment for building Emacs is under PROXY, you can use =emacs-mirror= to get Emacs source codes. Please change the URL of the git repository specified in =emacs-head.sh= and =emacs-28.1.sh= if needed.

** Pre-built distribution package
   :PROPERTIES:
   :ID:       3A8A27A7-93D9-4F4E-A621-042FC4521D14
   :END:

You can download my pre-built Emacs 26.3, 27.1, 27.2, 28.1 and HEAD with ns-inline patch. =Emacs.app= will be installed under =/Applications/Emacs-takaxp= in your macOS. The pkg contains =GnuTLS= and =jansson=. These packages are signed and notarized with my Apple developer ID: H2PH8KNN3H.

*** Emacs 29x (with inline patch) *!unstable!*
    :PROPERTIES:
    :ID:       9B7E9F4F-E5C7-4A09-A06B-7E1E58ADBDB9
    :END:

These packages are built based on the current development source code. So it may be unstable or broken.

| Chip  | Version | Download         | macOS   | [MB] | md5                              |
|-------+---------+------------------+---------+------+----------------------------------|
| Apple | 29.0.50 | [[https://pxaka.tokyo/emacs/pkg/emacs-head_apple.pkg][pkg]] (2022-06-18) | Big Sur | 54.9 | [[https://pxaka.tokyo/emacs/pkg/emacs-head_apple.md5][0de074272417950fc486978eec8dddce]] |
| Intel | 29.0.50 | [[https://pxaka.tokyo/emacs/pkg/emacs-head_intel.pkg][pkg]] (2022-06-18) | Big Sur | 55.4 | [[https://pxaka.tokyo/emacs/pkg/emacs-head_intel.md5][0716b6f16a2b2345485dfc457562ff16]] |

*** Emacs 28 (with inline patch)
| Chip  | Version | Download         | macOS             | [MB] | md5                              |
|-------+---------+------------------+-------------------+------+----------------------------------|
| Apple |    28.1 | [[https://pxaka.tokyo/emacs/pkg/emacs-28.1_apple.pkg][pkg]] (2022-05-09) | Big Sur[*1]       | 55.0 | [[https://pxaka.tokyo/emacs/pkg/emacs-28.1_apple.md5][29589057e1911dfec50b7a6c8fae890f]] |
| Intel |    28.1 | [[https://pxaka.tokyo/emacs/pkg/emacs-28.1_intel.pkg][pkg]] (2022-05-09) | Big Sur, Monterey | 55.4 | [[https://pxaka.tokyo/emacs/pkg/emacs-28.1_intel.md5][a2823a3e929bcf90e67b144dd1db220d]] |

[*1] Not tested in Monterey but it probably be installed

*** Emacs 27 (with inline patch)
| Chip  | Version | Download         | macOS             | [MB] | md5                              |
|-------+---------+------------------+-------------------+------+----------------------------------|
| Apple |    27.2 | [[https://pxaka.tokyo/emacs/pkg/emacs-27.2_apple.pkg][pkg]] (2022-05-09) | Big Sur[*1]       | 51.4 | [[https://pxaka.tokyo/emacs/pkg/emacs-27.2_apple.md5][52fda7e597430ae86997555317ff11b2]] |
| Intel |    27.2 | [[https://pxaka.tokyo/emacs/pkg/emacs-27.2_intel.pkg][pkg]] (2022-05-09) | Big Sur, Monterey | 51.8 | [[https://pxaka.tokyo/emacs/pkg/emacs-27.2_intel.md5][58f315e392a9fa893d3260eaf7424fe1]] |
| Intel |    27.1 | [[https://pxaka.tokyo/emacs/pkg/emacs-27.1.pkg][pkg]]              | Catalina          | 51.3 | 0c7048d147dea6fcdda638a25b161af8 |

[*1] Not tested in Monterey but it probably be installed

(previous built)
| Chip  | Version | Download  | macOS   | [MB] | md5                              |
|-------+---------+-----------+---------+------+----------------------------------|
| Apple |    27.2 | [[https://pxaka.tokyo/emacs/pkg/previous/emacs-27.2_apple.pkg][pkg]] (old) | Big Sur | 51.2 | 2cc963b00c0d41c038941ebb35e18446 |
| Intel |    27.2 | [[https://pxaka.tokyo/emacs/pkg/previous/emacs-27.2_intel.pkg][pkg]] (old) | [*2]    | 51.8 | 74e06cb24c8898a261d5778892355d3a |

[*2] Mojave / Catalina / Big Sur

*** Emacs 26 (with inline patch)
| Chip  | Version | Download | macOS    | [MB] | md5                              |
|-------+---------+----------+----------+------+----------------------------------|
| Intel |    26.3 | [[https://pxaka.tokyo/emacs/pkg/emacs-26.3.pkg][pkg]]      | Catalina | 52.9 | 1868c787177f515f18f500ce6b898b05 |

*** without inline (pure)

Additionally, the following package is "WITHOUT" inline-patch NS build. In this case, =Emacs.app= will be installed under =/Applications/Emacs-takaxp/pure=.

#+caption: pure
| Chip  | Version | Download              | macOS             | [MB] | md5                              |
|-------+---------+-----------------------+-------------------+------+----------------------------------|
| Apple |    28.1 | [[https://pxaka.tokyo/emacs/pkg/emacs-28.1_apple_pure.pkg][pure.pkg]] (2022-05-09) | Big Sur[*1]       | 55.0 | [[https://pxaka.tokyo/emacs/pkg/emacs-28.1_apple_pure.md5][e7fa6185f55d0578a236e35ee1dd0f12]] |
| Intel |    28.1 | [[https://pxaka.tokyo/emacs/pkg/emacs-28.1_intel_pure.pkg][pure.pkg]] (2022-05-09) | Big Sur, Monterey | 55.4 | [[https://pxaka.tokyo/emacs/pkg/emacs-28.1_intel_pure.md5][1f20caee450e46fb1afca50ffc6dfb22]] |
|-------+---------+-----------------------+-------------------+------+----------------------------------|
| Apple |    27.2 | [[https://pxaka.tokyo/emacs/pkg/emacs-27.2_apple_pure.pkg][pure.pkg]]              | Big Sur           | 51.2 | 64583b05ebf4d9aa89e8812af980b06f |
| Intel |    27.2 | [[https://pxaka.tokyo/emacs/pkg/emacs-27.2_intel_pure.pkg][pure.pkg]]              | [*2]              | 51.7 | 165fed95067d5b4b6d885bfacd1ff9fa |
| Intel |    27.1 | [[https://pxaka.tokyo/emacs/pkg/emacs-27.1_pure.pkg][pure.pkg]]              | Catalina          | 51.3 | fdd14baf87ed4f903b5b02c4e1dd022c |

[*1] Not tested in Monterey but it probably be installed
[*2] Mojave / Catalina / Big Sur

*** Integrated dynamic libraries:

 - libffi.7.dylib (or libffi.8.dylib)
 - libgmp.10.dylib
 - libgnutls.30.dylib
 - libhogweed.6.dylib
 - libidn2.0.dylib
 - libintl.8.dylib
 - libjansson.4.dylib
 - libnettle.8.dylib
 - libp11-kit.0.dylib
 - libtasn1.6.dylib
 - libunistring.2.dylib

The =system-configuration-features= is:

=NOTIFY KQUEUE ACL GNUTLS LIBXML2 ZLIB TOOLKIT_SCROLL_BARS NS MODULES THREADS JSON PDUMPER=

Enjoy!

